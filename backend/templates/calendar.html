{% extends 'base.html' %}
{% load static %}
{% block content %}
	<section class="ftco-section">
		<div class="container">
			<div class="row justify-content-center">
				<div class="col-md-6 text-center mb-5">
					<h2 class="heading-section">{{calendar.name}}'s Calendar</h2>
				</div>
			</div>
			<!-- Calendar ::: generated by a script in main.js-->
			<div class="row">
					<div class="day-info col-md-4" id="day-info">
						<form method="post" action="{% url 'create-day' %} ">
							{% csrf_token %}
							<label for="date">Day:</label>
							<input name="date" hidden>
							<input name="calendar" value="{{ calendar.id }}" hidden>
							<p>Mood Score:<p>
							<input type="radio" name="mood_score" id="mood_score_0" value="0">
							<label for="mood_score_0">0</label>
							<input type="radio" name="mood_score" id="mood_score_1" value="1">
							<label for="mood_score_2">1</label>
							<input type="radio" name="mood_score" id="mood_score_2" value="2">
							<label for="mood_score_1">2</label>
							<input type="radio" name="mood_score" id="mood_score_3" value="3">
							<label for="mood_score_2">3</label>
							<input type="radio" name="mood_score" id="mood_score_4" value="4">
							<label for="mood_score_4">4</label>
							<input type="radio" name="mood_score" id="mood_score_5" value="5">
							<label for="mood_score_5">5</label>
							<br>
							<div>
								<label class="col-md-12" for="comments">Comments: </label>
								<textarea  rows='6' cols='50' name="comments"></textarea><br>
							</div>
							<button class="btn btn-primary" type="submit">Submit</button>
						</form>	
					</div>
				<div class="col-md-8">
					<div class="calendar calendar-first" id="calendar_first">
				    <div class="calendar_header">
				        <button class="switch-month switch-left"> <i class="fa fa-chevron-left"></i></button>
				         <h2></h2>
				        <button class="switch-month switch-right"> <i class="fa fa-chevron-right"></i></button>
				    </div>
				    <div class="calendar_weekdays"></div>
				    <div class="calendar_content"></div>
					</div>
				</div>
			</div>
		</div>
		<button class="btn btn-success" onclick="getStatisticsFromAPI()">Statistics</button>
		<a href="{% url 'logout-view' %}"><button class="btn btn-danger">Logout</button></a>
		<div class="statistics-container"></div>
	</section>
	
	<script src="{% static 'js/jquery.min.js' %}"></script>
  	<script src="{% static 'js/popper.js' %}"></script>
  	<script src="{% static 'js/bootstrap.min.js' %}"></script>
  	<script src="{% static 'js/main.js' %}"></script>
	<script>
		
		let api_data = []
		
		function getDaysApi(){
			const api_url = "{% url 'days-api' calendar.id %}" 
			$.ajax({
					type: "GET",
					dataType: "json",
					url: api_url,
					contentType: "application/json",
						success: function (data) {
						api_data = data;
						}
			})
		}
		//to make every day colored in a specific color based on the mood_score of the day
		function fillColor(data){
			
			const colors = {
				0:"gray",
				1:"red",
				2:"orange",
				3:"yellow",
				4:"green",
				5:"blue"
			}

			for (var i = 0; i<data.length;i++){
				const day = data[i]
				const day_id = "#" + day.date
				$(day_id).css("background-color",colors[day.mood_score.toString()]);			
			}}

		//the intention is to have the colors appear from the get go..
		$(document).ready(function () {
			setTimeout(function () {
				getDaysApi()
				fillColor(api_data)
			},1)

			
		});

		$(document).on("click", function(event){
			var clicked = event.target
			var selected_day = api_data.filter(function (entry) {return entry.date === clicked.id})[0] //finding value in a list using .filter()
			if ($(clicked).hasClass("past-date") || $(clicked).hasClass('today')){ //ignore days that haven't passed yet
				//updates form labels and a hidden input to be sent to the backend
				$("input[name='date']").val(clicked.id);
				$("label[for='date']").html("Day: " + clicked.id)
				if(selected_day){
					//updates form values
					$("textarea[name='comments']").val(selected_day.comments)
					
					$("#mood_score_" + selected_day.mood_score).prop("checked",true)
				} else {
					$("textarea[name='comments']").val("")
					$("#mood_score_5").prop("checked",true)
				}
				
			}});

		
		function getStatisticsFromAPI(){
			let statistics_api_url = "{{statistics_api_url}}" + "{{ calendar.id }}"
			let statistics = {}
			$.ajax({
					type: "GET",
					url: statistics_api_url,
					success: function (data) {
						$(".statistics-container").html(data.toString())
						console.log(data);
						}
			})
			return statistics

		}

		//solution for auto populating the colors into the calendar (it works by resizing the div)
		// found on http://www.backalleycoder.com/2013/03/18/cross-browser-event-based-element-resize-detection/
		(function(){
			var attachEvent = document.attachEvent;
			var isIE = navigator.userAgent.match(/Trident/);
			console.log(isIE);
			var requestFrame = (function(){
				var raf = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame ||
					function(fn){ return window.setTimeout(fn, 20); };
				return function(fn){ return raf(fn); };
			})();
			
			var cancelFrame = (function(){
				var cancel = window.cancelAnimationFrame || window.mozCancelAnimationFrame || window.webkitCancelAnimationFrame ||
					window.clearTimeout;
				return function(id){ return cancel(id); };
			})();
			
			function resizeListener(e){
				var win = e.target || e.srcElement;
				if (win.__resizeRAF__) cancelFrame(win.__resizeRAF__);
				win.__resizeRAF__ = requestFrame(function(){
					var trigger = win.__resizeTrigger__;
					trigger.__resizeListeners__.forEach(function(fn){
						fn.call(trigger, e);
					});
				});
			}
	
			function objectLoad(e){
				this.contentDocument.defaultView.__resizeTrigger__ = this.__resizeElement__;
				this.contentDocument.defaultView.addEventListener('resize', resizeListener);
			}
			
			window.addResizeListener = function(element, fn){
				if (!element.__resizeListeners__) {
					element.__resizeListeners__ = [];
				if (attachEvent) {
					element.__resizeTrigger__ = element;
					element.attachEvent('onresize', resizeListener);
				} else {
					if (getComputedStyle(element).position == 'static') element.style.position = 'relative';
					var obj = element.__resizeTrigger__ = document.createElement('object'); 
					obj.setAttribute('style', 'display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden; pointer-events: none; z-index: -1;');
					obj.__resizeElement__ = element;
					obj.onload = objectLoad;
					obj.type = 'text/html';
					if (isIE) element.appendChild(obj);
					obj.data = 'about:blank';
					if (!isIE) element.appendChild(obj);
				}
			}
			element.__resizeListeners__.push(fn);
			};
		
			window.removeResizeListener = function(element, fn){
				element.__resizeListeners__.splice(element.__resizeListeners__.indexOf(fn), 1);
				if (!element.__resizeListeners__.length) {
					if (attachEvent) element.detachEvent('onresize', resizeListener);
					else {
					element.__resizeTrigger__.contentDocument.defaultView.removeEventListener('resize', resizeListener);
					element.__resizeTrigger__ = !element.removeChild(element.__resizeTrigger__);
				}
				}
			}
		})();
		var calendarDiv = document.getElementById('calendar_first'), colorDiv = function(){
			fillColor(api_data)
		};
		addResizeListener(calendarDiv,colorDiv)
		// auto populating colors
	</script>
{% endblock %}
